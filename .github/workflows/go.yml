name: Docker

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:

    - name: Check out code
      uses: actions/checkout@v2

    - name: docker
      uses: docker://docker
      with:
        args: /bin/sh ./build.sh
      env:
        REGISTRY_ENDPOINT: registry.hub.docker.com
        REGISTRY_REPO: registry.hub.docker.com/dockerdig/hello-world
        REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
        REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  dispatch:
    needs: build
    strategy:
      matrix:
        repo: ['slaystack/xops']

    name: Dispatch
    runs-on: ubuntu-latest
    steps:

      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.PA_TOKEN }}
          repository: ${{ matrix.repo }}
          event-type: ops_update
          client_payload: '{
            "app" : "demo",
            "dependency" : "demo",
            "github": "${{ tojson(github) }}"
          }'

